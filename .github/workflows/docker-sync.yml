name: "Docker Image Sync to ACR"

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker Hub é•œåƒå (ä¾‹å¦‚: mysql:8.0)'
        required: true
        default: 'mysql:latest'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: crpi-tjpbhu7ev24zh1rq.cn-hangzhou.personal.cr.aliyuncs.com
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Pull and Push to Aliyun
        run: |
          # 1. è·å–è¾“å…¥å€¼
          RAW_IMAGE="${{ github.event.inputs.image_name }}"
          
          # 2. ä» Docker Hub æ‹‰å–
          echo "ğŸ“¥ æ­£åœ¨æ‹‰å–æºé•œåƒ: $RAW_IMAGE"
          docker pull "$RAW_IMAGE"
          
          # 3. æ ¸å¿ƒä¿®å¤ï¼šå¤„ç†æ ‡ç­¾æ ¼å¼ï¼ˆåŒ…å«å°å†™è½¬æ¢ï¼‰
          # sed 's/[\/:]/_/g' : å°† / å’Œ : æ›¿æ¢ä¸º _
          # tr '[:upper:]' '[:lower:]' : å°†å¤§å†™å­—æ¯å¼ºåˆ¶è½¬ä¸ºå°å†™ï¼Œè§£å†³ Docker è§„èŒƒæŠ¥é”™
          SAFE_TAG=$(echo "$RAW_IMAGE" | sed 's/[\/:]/_/g' | tr '[:upper:]' '[:lower:]')
          
          # 4. æ‹¼æ¥æœ€ç»ˆé•œåƒåœ°å€
          TARGET_IMAGE="crpi-tjpbhu7ev24zh1rq.cn-hangzhou.personal.cr.aliyuncs.com/garendeng_zhanhao/james-hub:$SAFE_TAG"
          
          # 5. æ‰“æ ‡ç­¾å¹¶æ¨é€
          echo "ğŸ“¤ æ­£åœ¨æ¨é€è‡³é˜¿é‡Œäº‘: $TARGET_IMAGE"
          docker tag "$RAW_IMAGE" "$TARGET_IMAGE"
          docker push "$TARGET_IMAGE"
          
          echo "=========================================================="
          echo "âœ… åŒæ­¥æˆåŠŸï¼"
          echo "ğŸš€ é˜¿é‡Œäº‘æ‹‰å–å‘½ä»¤ï¼š"
          echo "docker pull $TARGET_IMAGE" 
          echo "ğŸ“¦ æºé•œåƒåç§°: $RAW_IMAGE"
          echo "ğŸ·ï¸ è½¬æ¢åæ ‡ç­¾: $SAFE_TAG"
          echo "=========================================================="



