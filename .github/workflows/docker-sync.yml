name: Docker Image Sync to ACR

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker Hub é•œåƒå (ä¾‹å¦‚: mysql:8.0)'
        required: true
        default: 'mysql:latest'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Pull and Push to Aliyun
        run: |
          # 1. è·å–è¾“å…¥å€¼ (å¦‚: 1panel/openresty:1.27.1.2)
          RAW_IMAGE="${{ github.event.inputs.image_name }}"
          echo "æ­£åœ¨å¤„ç†é•œåƒ: $RAW_IMAGE"
          
          # 2. ä» Docker Hub æ‹‰å–
          docker pull "$RAW_IMAGE"
          
          # 3. æ ¸å¿ƒä¿®å¤ï¼šç”Ÿæˆå®‰å…¨çš„æ ‡ç­¾å
          # ä½¿ç”¨ RAW_IMAGE ä½œä¸ºè¾“å…¥ï¼Œå°† / å’Œ : å…¨éƒ¨æ›¿æ¢ä¸º _
          # è¿™æ · 1panel/openresty:1.27.1.2 å°±ä¼šå˜æˆ 1panel_openresty_1.27.1.2
          SAFE_TAG=$(echo "$RAW_IMAGE" | sed 's/[\/:]/_/g')
          
          # 4. æ‹¼æ¥æœ€ç»ˆé•œåƒåœ°å€
          # å˜é‡åå¿…é¡»ä¸¥æ ¼ä¸€è‡´ï¼š$SAFE_TAG
          TARGET_IMAGE="${{ secrets.ACR_REGISTRY }}/garendeng_zhanhao/james-hub:$SAFE_TAG"
          
          echo "å‡†å¤‡æ¨é€è‡³ ACR: $TARGET_IMAGE"
          
          # 5. æ‰“æ ‡ç­¾å¹¶æ¨é€
          docker tag "$RAW_IMAGE" "$TARGET_IMAGE"
          docker push "$TARGET_IMAGE"
          
          echo "=========================================================="
          echo "âœ… åŒæ­¥æˆåŠŸï¼"
          echo "ğŸš€ é˜¿é‡Œäº‘æ‹‰å–å‘½ä»¤ï¼š"
          echo "docker pull $TARGET_IMAGE"
          echo "=========================================================="


