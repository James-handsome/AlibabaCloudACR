name: Update Image List

on:
  schedule:
    - cron: '0 * * * *' # 每小时自动运行一次
  workflow_dispatch: # 支持你在 Actions 页面手动点击运行

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch from Aliyun
        env:
          AK_ID: ${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_ID }}
          AK_SECRET: ${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_SECRET }}
        run: |
          pip install alibabacloud_cr20181201==2.0.2
          python - <<EOF
          import os, json
          from alibabacloud_cr20181201.client import Client
          from alibabacloud_tea_openapi import models as open_api_models
          from alibabacloud_cr20181201 import models as cr_20181201_models

          # 初始化配置
          config = open_api_models.Config(
              access_key_id=os.environ['AK_ID'],
              access_key_secret=os.environ['AK_SECRET'],
              region_id='cn-hangzhou'
          )
          client = Client(config)
          
          # 你的实例信息
          instance_id = 'crpi-tjpbhu7ev24zh1rq'
          namespace = 'garendeng_zhanhao'
          repo = 'james-hub'

          try:
              # 1. 查询 RepoId
              list_repo_req = cr_20181201_models.ListRepositoryRequest(
                  instance_id=instance_id,
                  repo_namespace=namespace,
                  repo_name=repo
              )
              repos = client.list_repository(list_repo_req)
              
              if not repos.body.repositories:
                  raise Exception("找不到该镜像仓库，请检查名称是否正确")
              
              repo_id = repos.body.repositories[0].repo_id
              print(f"找到 RepoId: {repo_id}")

              # 2. 查询 Tag 列表
              tag_req = cr_20181201_models.ListRepoTagRequest(
                  instance_id=instance_id,
                  repo_id=repo_id,
                  page_size=100
              )
              tag_res = client.list_repo_tag(tag_req)
              tags = [item.tag for item in tag_res.body.images]
              
              # 写入 data.json
              with open('data.json', 'w') as f:
                  json.dump({"images": tags, "update_time": os.popen('date').read().strip()}, f)
              print("data.json 生成成功")

          except Exception as e:
              print(f"运行出错: {e}")
              exit(1)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add data.json
          git commit -m "自动更新镜像列表" || exit 0
          git push
