- name: Fetch from Aliyun
        env:
          AK_ID: ${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_ID }}
          AK_SECRET: ${{ secrets.ALIBABA_CLOUD_ACCESS_KEY_SECRET }}
        run: |
          pip install alibabacloud_cr20181201==2.0.2
          python - <<EOF
          import os, json
          from alibabacloud_cr20181201.client import Client
          from alibabacloud_tea_openapi import models as open_api_models
          from alibabacloud_cr20181201 import models as cr_20181201_models

          # 初始化客户端
          config = open_api_models.Config(
              access_key_id=os.environ['AK_ID'],
              access_key_secret=os.environ['AK_SECRET'],
              region_id='cn-hangzhou'
          )
          client = Client(config)
          
          instance_id = 'crpi-tjpbhu7ev24zh1rq'
          namespace = 'garendeng_zhanhao'
          repo_name = 'james-hub'

          try:
              # 第一步：根据名字查询 RepoId
              list_repo_req = cr_20181201_models.ListRepositoryRequest(
                  instance_id=instance_id,
                  repo_name=repo_name,
                  repo_namespace=namespace
              )
              repos = client.list_repository(list_repo_req)
              
              if not repos.body.repositories:
                  raise Exception(f"找不到仓库: {namespace}/{repo_name}")
              
              # 拿到那个关键的身份证号
              repo_id = repos.body.repositories[0].repo_id
              print(f"找到 RepoId: {repo_id}")

              # 第二步：使用 RepoId 查询 Tag 列表
              tag_req = cr_20181201_models.ListRepoTagRequest(
                  instance_id=instance_id,
                  repo_id=repo_id,
                  page_size=100
              )
              tag_res = client.list_repo_tag(tag_req)
              tags = [item.tag for item in tag_res.body.images]
              
              print(f"成功获取到标签: {tags}")
              
              # 写入文件
              with open('data.json', 'w') as f:
                  json.dump({
                      "images": tags, 
                      "update_time": os.popen('date').read().strip()
                  }, f)

          except Exception as e:
              print(f"出错了: {e}")
              exit(1) # 让 Action 报错，方便我们排查
          EOF
